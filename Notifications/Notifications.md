# User Notifications

User facing notifications play an important role in communicating users of apps 
important information about some events they might be interested in or about some 
event in the app they might need to know about.


## Benefits

Using push notifications can have below benefits
- Updates
- Dynamic experience
- Increased user engagement
- Being push, these do not require app to be in foreground
- Push notifications are power efficient

User notifications can be
- Local Notifications
- Remote Notifications


## Local Notifications

App can generate notifications locally by specifying the content and condition for 
delivery like time or location which will trigger the application. User can change 
authorization status anytime so before scheduling a local notification one should 
always check the status.


## Remote Notifications
Remote notifications are trigerred from a provider via APNs i.e. Apple Push Notification 
service. If an app supports remote notifications then app needs to have a provider 
server. This provider server will actually talk to APNs and request for notification 
which APNs will further publish to App. So when there is a notification to send, 
the provider server must construct a POST request and send it to APNs.

The POST request should contain following :
- JSON Payload
- Device token of user's device
- Request header fields
- Provider's current auth token (if token based authentication) This authentication 
is for provider server to be authenticated.


## Reasons for push notifications failure
1. Some failed logic at provider server.
2. Push certificate expiry.
3. Wrond device token.
4. User has turned off permission to receive push notifications.
5. Device in low power mode.


## What is device token?

A device token is generated by APNs servers once user authorizes app to use push
notifications. This device token uniquely identifies an app for a particular device.


## New WWDC 2023
## Push Notifications Console

- Send notifications
    One can configure and send a push notification using Push Notifications Console.
    This console also keeps a history of notifications sent, which can be edited
    and send again.
    
- Examine delivery logs
    This is required to analyze cases when a notification sent isn't received. The
    events reflecting the delivery process for a notification as it travels through
    APNs are recorded. This information can be retrieved now using the header returned
    from APNs(**apns-unique-id**) when notification is sent.
    There is a delivery log tab in push notification console where this apns-unique-id
    can be searched to see detailed logs to understand what happened with notification.
    
- Debug with tools
    Push Notifications Console comes with tool to generate APNs authentication token
    by providing the private key generated form apple developer portal. Validity 
    of these token cannot exceed more than 1 hour.
    
    There is a token validation tool as well which will validate the above generated
    token.
    
    There is a device token validator.
    

## APNs Authentication

- Certificate based (SSL certificate)
- Token based (JSON based web token)


## Request Authorization

Before starting to push notifications to app, the app must ask for permissions to
use notifications, basically asking user's consent for getting these notifications.
Consent is required because user might consider notification based interactions as
disruptions, so permission must be obtained.

To ask for permission one should get shared instance of UNUserNotificationCenter
and call requestAuthorization(options:completionHandler:) method.
This requests user's authorization to allow :
- Local notifications
- Remote notifications

```
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .badge, .sound]) { granted, error in
            print("Permission granted: \(granted)")
        }
```

### Note
1. Always request for authorization before registering with Apple Push Notification
service.

2. Authorization should NOT be blindly requested at app launch, instead it should
be asked in a context which helps user understand why app needs authorization. It's 
not necessary or desirable to request for authorization on app launch itself. 
This ideally should be asked within some relvant context so as to give user more 
insight of what notification will be like. 
For e.g. suppose a grocery app let's you add some available coupon codes, so when 
user adds a coupon that time request can be made telling user that app can notify 
for coupons when available. This way user will get an understanding of why and how 
the notification can be helpful to him/her and can take informed decision.

3. First time authorization promp is shown and user's response is recorded, subsequent
calls for authorization doesn't show prompt again, unless app is deleted from device.

4. User at anytime can go to settings app and change the configurations for push
notifications. UNUserNotificationCenter's getNotificationSettings(completionHandler:)
can be used to retrieve the authorization and feature-related settings.
